{% extends 'base_v1_1.html' %}
{% load static %}
{% block heading_extra %}
    <link rel="stylesheet" href="{% static 'estilo.css' %}">
    <style>
        .category-item, .subcategory-item, .indicator-item {
            margin-bottom: 10px;
            cursor: pointer;
        }

        .category-item:hover, .subcategory-item:hover, .indicator-item:hover {
            background-color: #e2e6ea;
            padding-left: 10px;
        }
    </style>
{% endblock %}
{% block main %}
    <div class="container-fluid">
        <div class="row">
            <!-- Columna del Mapa que ocupará el 70% del ancho -->
            <div class="col-md-2" style="height: 70vh; overflow-y: auto;">
                <div class="accordion" id="categoryAccordion">
                    {% for category in categories %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading_{{ category.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapse_{{ category.id }}" aria-expanded="false"
                                        aria-controls="collapse_{{ category.id }}">
                                    {{ category.name }}
                                </button>
                            </h2>
                            <div id="collapse_{{ category.id }}" class="accordion-collapse collapse"
                                 aria-labelledby="heading_{{ category.id }}" data-bs-parent="#categoryAccordion">
                                <div class="accordion-body">
                                    <!-- Nested accordion for subcategories -->
                                    <div class="accordion" id="subcategoryAccordion_{{ category.id }}">
                                        <ul id="subcategory_{{ category.id }}" class="list-group">
                                            <!-- Subcategories will be dynamically loaded here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-md-8" style="height: 70vh;">
                <div class="card p-1" style="height: 100%;">
                    <div id="mapa" style="height: 100%;"></div>
                </div>
            </div>

            <!-- Columna lateral derecha que ocupará el 30% del ancho -->
            <div class="col-md-2" style="height: 70vh; display: flex; flex-direction: column;">
                <!-- Información -->
                <div class="card">
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-line nav-color-secondary" id="line-tab" role="tablist">
                            <li class="nav-item submenu" role="presentation">
                                <a class="nav-link active" id="line-home-tab" data-bs-toggle="pill" href="#line-home"
                                   role="tab" aria-controls="pills-home" aria-selected="true">Layers</a>
                            </li>
                            <li class="nav-item submenu" role="presentation">
                                <a class="nav-link" id="line-profile-tab" data-bs-toggle="pill" href="#line-profile"
                                   role="tab" aria-controls="pills-profile" aria-selected="false"
                                   tabindex="-1">Base Map</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3 mb-3" id="line-tabContent">
                            <div class="tab-pane fade active show" id="line-home" role="tabpanel"
                                 aria-labelledby="line-home-tab">

                            </div>
                            <div class="tab-pane fade" id="line-profile" role="tabpanel"
                                 aria-labelledby="line-profile-tab">
                                Base Map
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12 mt-1">
                <!-- Responsive Table -->
                <div class="card" id="table-section" style="flex-grow: 1;">
                    <div class="card-header">Table Data</div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 50%; overflow-y: auto;">
                            <table id="recordsTable" class="table table-striped">
                                <thead class="table-primary"> <!-- Blue background for the header -->
                                <tr>
                                    <th>Location</th>
                                    <th>Indicator</th>
                                    <th>Value</th>
                                    <th>Value Type</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tbody id="indicatorRecordsTable">

                                </tbody>
                                {#                                <tr>#}
                                {#                                    <td>Milagro</td>#}
                                {#                                    <td>Vulnerable Population Event El Niño</td>#}
                                {#                                    <td>50</td>#}
                                {#                                    <td>Percentage</td>#}
                                {#                                    <td>Affectation of the El Niño Event in the Río Milagro Area</td>#}
                                {#                                    <td>#}
                                {#                                        <!-- Action buttons: Edit and Delete -->#}
                                {#                                        <button class="btn btn-xs btn-outline-primary" title="Edit">#}
                                {#                                            <i class="fas fa-pencil-alt"></i> <!-- Edit icon -->#}
                                {#                                        </button>#}
                                {#                                        <button class="btn btn-xs btn-outline-danger" title="Delete">#}
                                {#                                            <i class="fas fa-times"></i> <!-- Delete icon -->#}
                                {#                                        </button>#}
                                {#                                        <button class="btn btn-xs btn-outline-info" title="Detail">#}
                                {#                                            <i class="fas fa-info"></i> <!-- Delete icon -->#}
                                {#                                        </button>#}
                                {#                                    </td>#}
                                {#                                </tr>#}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup sobre el mapa -->
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <span id="popup-title"></span>
            <div id="popup-content"></div>
        </div>
    </div>

{% endblock %}
{% block js_extra %}
    <script type="application/javascript">
        $(document).ready(function () {
            // Load subcategories when a category is clicked
            $('.accordion-button').on('click', function () {
                var categoryId = $(this).data('bs-target').replace('#collapse_', '');
                var subcategoryList = $('#subcategory_' + categoryId);

                if (subcategoryList.children().length === 0) {
                    $.ajax({
                        url: '/ajax/subcategories/' + categoryId +"/",
                        method: 'GET',
                        success: function (response) {
                            response.subcategories.forEach(function (subcategory) {
                                var subcatAccordion = `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading_subcategory_${subcategory.id}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapse_subcategory_${subcategory.id}" aria-expanded="false"
                                        aria-controls="collapse_subcategory_${subcategory.id}">
                                    ${subcategory.name}
                                </button>
                            </h2>
                            <div id="collapse_subcategory_${subcategory.id}" class="accordion-collapse collapse"
                                 aria-labelledby="heading_subcategory_${subcategory.id}">
                                <div class="accordion-body">
                                    <ul id="indicator_${subcategory.id}" class="list-group">
                                        <!-- Indicators (with checkboxes) will be loaded here dynamically -->
                                    </ul>
                                </div>
                            </div>
                        </div>`;
                                subcategoryList.append(subcatAccordion);

                                // Load indicators when the subcategory is expanded
                                loadIndicators(subcategory.id);
                            });
                        }
                    });
                }
            });

            // Function to load indicators with checkboxes
            function loadIndicators(subcategoryId) {
                var indicatorList = $('#indicator_' + subcategoryId);

                $.ajax({
                    url: '/ajax/indicators/' + subcategoryId+"/",
                    method: 'GET',
                    success: function (response) {
                        response.indicators.forEach(function (indicator) {
                            var indicatorItem = `
                        <li class="list-group-item">
                            <input type="checkbox" class="indicator-checkbox" value="${indicator.id}">
                            ${indicator.name}
                        </li>`;
                            indicatorList.append(indicatorItem);
                        });

                        // Attach change event to checkboxes for each indicator
                        indicatorList.find('.indicator-checkbox').on('change', function () {
                            fetchRecordsForSelectedIndicators();
                        });
                    }
                });
            }

            // Fetch records for selected indicators whenever a checkbox is checked or unchecked
            function fetchRecordsForSelectedIndicators() {
                var selectedIndicators = [];
                $('.indicator-checkbox:checked').each(function () {
                    selectedIndicators.push($(this).val());
                });

                if (selectedIndicators.length > 0) {
                    $.ajax({
                        url: '/ajax/records/',
                        method: 'POST',
                        data: {
                            'indicators': selectedIndicators,  // Send selected indicators as an array
                            'csrfmiddlewaretoken': '{{ csrf_token }}'  // Include CSRF token
                        },
                        success: function (response) {
                            updateRecordsTable(response.records);
                        }
                    });
                } else {
                    // If no indicators are selected, you can either clear the table or show a message
                    $('#indicatorRecordsTable').empty();  // Clear the table
                }
            }

            // Function to update the table with fetched records
            function updateRecordsTable(records) {
                var tableBody = $('#indicatorRecordsTable');
                tableBody.empty();  // Clear previous records

                records.forEach(function (record) {
                    var row = `
                <tr>
                    <td>${record.location}</td>
                    <td>${record.indicator}</td>
                    <td>${record.value}</td>
                    <td>${record.value_type}</td>
                    <td>${record.description}</td>
                    <td>
                        <button class="btn btn-sm btn-primary">View</button>
                    </td>
                </tr>`;
                    tableBody.append(row);
                });
            }
        });


        $(document).ready(function () {
            // Definir las opciones de GIS_TYPE_CHOICES en JavaScript
            const GIS_TYPE_CHOICES = [
                {value: 1, label: 'Point'},
                {value: 2, label: 'LineString'},
                {value: 3, label: 'Polygon'},
                {value: 4, label: 'MultiPoint'},
                {value: 5, label: 'MultiLineString'},
                {value: 6, label: 'MultiPolygon'},
            ];

            // Seleccionar el contenedor donde se agregarán los inputs
            const container = $('#line-home');

            // Iterar sobre las opciones y agregar los inputs dinámicamente
            GIS_TYPE_CHOICES.forEach(choice => {
                const inputElement = `
                <div class="">
                    <input type="radio" id="gis-type-${choice.value}" name="gis_type" value="${choice.value}" class="form-check-input">
                    <label for="gis-type-${choice.value}">${choice.label}</label>
                </div>
            `;
                container.append(inputElement);
            });
        });
    </script>

    <script src="{% static 'ol7/ol.js' %}"></script>
    <link rel="stylesheet" href="{% static 'ol7/ol.css' %}">
    <script src="{% static 'ol7/ol-layerswitcher.js' %}"></script>
    <link rel="stylesheet" href="{% static 'ol7/ol-layerswitcher.css' %}">
    <script src="{% static 'home_gis.js' %}?v=1.0.3"></script>
{% endblock %}