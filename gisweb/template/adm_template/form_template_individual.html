{% extends 'base_v1_1.html' %}
{% block heading_extra %}
    <!-- OpenLayers CSS -->
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <!-- Include Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.1.0/ol.css">

    <style>
        /* Style for the map container */
        #map {
            width: 100%;
            height: 500px;
        }

        #info {
            margin-top: 20px;
        }
    </style>
{% endblock %}
{% block main %}
    <form class="row g-3" method="POST">
        {% csrf_token %}

        <div class="col-md-6">
            <!-- Section 1: Geographical Location -->
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title">Geographical Location</h4>

                    <!-- Country -->
                    {% for sector_type in sector_types %}
                        <div class="form-group" id="sector_{{ sector_type.id }}_section"
                             style="display: {{ forloop.first|yesno:'block,none' }};">
                            <label for="sector_{{ sector_type.id }}">{{ sector_type.name }}:</label>
                            <select id="sector_{{ sector_type.id }}" class="form-control sector-select"
                                    data-level="{{ sector_type.id }}">
                                <option value="">Select an option</option>
                                {% if forloop.first %}
                                    {% for sector in sectors_by_type %}
                                        {% if sector.sector_type_id == first_sector_type.id %}
                                            <option value="{{ sector.id }}">{{ sector.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Section 2: Geography Type -->
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title">Geography Type</h4>
                    <div class="mb-3">
                        <label for="tipo-geografia" class="form-label">Geography Type:</label>
                        <select id="tipo-geografia" name="tipo_geografia" class="form-select">
                            <option value="punto">Point</option>
                            <option value="poligono">Polygon</option>
                            <option value="multipunto">Multipoint</option>
                        </select>
                    </div>

                    <!-- Interactive map would be included here -->
                    <div id="map" class="mb-3 border" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Section 3: Indicator Settings on the right side -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title">Indicator Settings</h4>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="categoria" class="form-label">Category:</label>
                        <select id="categoria" name="categoria" class="form-select">
                            <option value="salud">Health</option>
                            <option value="educacion">Education</option>
                        </select>
                    </div>

                    <!-- Subcategory -->
                    <div class="mb-3">
                        <label for="subcategoria" class="form-label">Subcategory:</label>
                        <select id="subcategoria" name="subcategoria" class="form-select">
                            <option value="desnutricion">Malnutrition</option>
                            <option value="mortalidad">Mortality</option>
                        </select>
                    </div>

                    <!-- Indicator -->
                    <div class="mb-3">
                        <label for="indicador" class="form-label">Indicator:</label>
                        <select id="indicador" name="indicador" class="form-select">
                            <option value="desnutricion">Indicator 1</option>
                            <option value="mortalidad">Indicator 2</option>
                        </select>
                    </div>

                    <!-- Indicator Description -->
                    <div class="mb-3">
                        <label for="des_indicador" class="form-label">Indicator Description:</label>
                        <input type="text" id="des_indicador" name="descripcion_indicador" class="form-control"
                               placeholder="Indicator Description">
                    </div>

                    <!-- Indicator Value -->
                    <div class="mb-3">
                        <label for="valor" class="form-label">Value:</label>
                        <input type="text" id="valor" name="valor" class="form-control" placeholder="Value">
                    </div>

                    <!-- Minimum and Maximum Value -->
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label for="min-valor" class="form-label">Minimum Value:</label>
                            <input type="number" id="min-valor" name="valor_minimo" class="form-control"
                                   placeholder="Min.">
                        </div>
                        <div class="col-md-6">
                            <label for="max-valor" class="form-label">Maximum Value:</label>
                            <input type="number" id="max-valor" name="valor_maximo" class="form-control"
                                   placeholder="Max.">
                        </div>
                    </div>

                    <!-- Button to add additional fields -->
                    <div id="campos-adicionales" class="mt-3"></div>
                    <button type="button" id="add-campo" class="btn btn-secondary mt-2">+ New Field</button>
                </div>
            </div>
        </div>

        <!-- Button to submit the form (full width) -->
        <div class="col-12">
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </div>
    </form>

{% endblock %}
{% block js_extra %}
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.1.0/dist/ol.js"></script>
    <script type="application/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var sectorSelects = document.querySelectorAll('.sector-select');
            var map;  // Variable for the Leaflet map
            var penultimoLayer;  // Layer for the penultimate level geometry
            var ultimoLayer;  // Layer for the last level geometry

            // Create the Leaflet map when the page loads
            function initMap() {
                map = L.map('map').setView([0, 0], 2);  // Adjust initial coordinates as necessary

                // Add a base layer from OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }

            initMap();  // Initialize the map when the page loads

            // Add event to each dynamic select field
            sectorSelects.forEach(function (select) {
                select.addEventListener('change', function () {
                    var selectedValue = this.value;
                    var currentLevel = this.dataset.level;
                    var nextLevel = parseInt(currentLevel) + 1;

                    // Detect if it's the penultimate level
                    if (document.getElementById(`sector_${nextLevel}`)) {
                        // Load the geometry of the penultimate level and display it on the map
                        cargarGeometriaYMostrarEnMapa(selectedValue, true);
                        cargarSectores(selectedValue, nextLevel);  // Load the next level
                    } else if (!document.getElementById(`sector_${nextLevel}`)) {
                        // If it's the last level, load the geometry and overlay it on the penultimate level
                        cargarGeometriaYMostrarEnMapa(selectedValue, false);
                    }
                });
            });

            // Function to load child sectors
            function cargarSectores(parent_id, next_level) {
                var url = '/ajax/cargar-sectores/';
                var nextSelect = document.getElementById(`sector_${next_level}`);
                var nextSection = document.getElementById(`sector_${next_level}_section`);

                // Make an AJAX request to get the child sectors
                fetch(url + '?parent_id=' + parent_id)
                    .then(response => response.json())
                    .then(data => {
                        // Clear the next select
                        nextSelect.innerHTML = '<option value="">Select an option</option>';
                        // Add the new options
                        data.forEach(function (item) {
                            var option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name;
                            nextSelect.appendChild(option);
                        });
                        // Display the next section
                        nextSection.style.display = 'block';
                    })
                    .catch(error => console.error('Error loading sectors:', error));
            }

            // Function to load geometry and display it on the map
            function cargarGeometriaYMostrarEnMapa(sector_id, isPenultimoNivel) {
                var url = '/ajax/cargar-geom-sector/?sector_id=' + sector_id;

                // Make an AJAX request to get the geometry of the sector
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        data.map(function (reg) {
                            var geometryType = reg.geometry_type;
                            var coordinates = reg.coordinates;

                            // Verify that geometry and coordinates data exist
                            if (!geometryType || !coordinates) {
                                console.error('Geometry data not found or invalid.');
                                return;  // Stop if there is no geometry or coordinates
                            }

                            // If it's the penultimate level, remove both penultimo and ultimo layers
                            if (isPenultimoNivel) {
                                if (penultimoLayer) {
                                    map.removeLayer(penultimoLayer);
                                }
                                if (ultimoLayer) {
                                    map.removeLayer(ultimoLayer);
                                }
                            } else {
                                // If it's the last level, remove only the ultimoLayer
                                if (ultimoLayer) {
                                    map.removeLayer(ultimoLayer);
                                }
                            }

                            var newLayer = null;

                            // Show geometry based on type
                            if (geometryType === 'Point') {
                                var point = L.latLng(coordinates[1], coordinates[0]);  // Swap [lon, lat] to [lat, lon]
                                newLayer = L.marker(point);
                                map.setView(point, 14);  // Center and zoom in on the point
                            } else if (geometryType === 'LineString') {
                                var latlngs = coordinates.map(function (coord) {
                                    return [coord[1], coord[0]];  // Swap [lon, lat] to [lat, lon]
                                });
                                newLayer = L.polyline(latlngs);
                                map.fitBounds(newLayer.getBounds());  // Adjust view to the line
                            } else if (geometryType === 'Polygon') {
                                var latlngs = coordinates[0].map(function (coord) {
                                    return [coord[1], coord[0]];  // Swap [lon, lat] to [lat, lon]
                                });
                                newLayer = L.polygon(latlngs);
                                map.fitBounds(newLayer.getBounds());  // Adjust view to the polygon
                            } else if (geometryType === 'MultiPolygon') {
                                var latlngs = coordinates.map(function (polygon) {
                                    return polygon[0].map(function (coord) {
                                        return [coord[1], coord[0]];  // Swap [lon, lat] to [lat, lon]
                                    });
                                });
                                newLayer = L.polygon(latlngs);
                                map.fitBounds(newLayer.getBounds());  // Adjust view to the multipolygon
                            }

                            // If a layer was created (newLayer), add it to the map and store it
                            if (newLayer) {
                                newLayer.addTo(map);

                                // Save the layer in the correct variable
                                if (isPenultimoNivel) {
                                    penultimoLayer = newLayer;  // Save the penultimate level layer
                                } else {
                                    ultimoLayer = newLayer;  // Save the last level layer
                                }
                            } else {
                                console.error('Could not create geometry layer for type:', geometryType);
                            }
                        });
                    })
                    .catch(error => console.error('Error loading geometry:', error));
            }
        });
    </script>

{% endblock %}
